<!DOCTYPE html><html lang="en"><head><title>alert-this-and-that/alert-this-and-that</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="alert-this-and-that/alert-this-and-that"><meta name="groc-project-path" content="alert-this-and-that/alert-this-and-that.coffee"><meta name="groc-github-url" content="https://github.com/OlenDavis/google-maps-a-directive"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/OlenDavis/google-maps-a-directive/blob/master/alert-this-and-that/alert-this-and-that.coffee">alert-this-and-that/alert-this-and-that.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="alert-this-and-that">alert-this-and-that</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="indexhtml">index.html</h2>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html ng-app="aModule"&gt;

    &lt;head&gt;
        &lt;link rel="stylesheet" href="style.css"&gt;
        &lt;script data-require="angular.js@1.3.0-beta.19" data-semver="1.3.0-beta.19" src="https://code.angularjs.org/1.3.0-beta.19/angular.js"&gt;&lt;/script&gt;
        &lt;script src="alert-this-and-that.js"&gt;&lt;/script&gt;
    &lt;/head&gt;

    &lt;body class="less padded"&gt;
        &lt;div
            class               ="bordered more padded rounded less-b-margin"
            ng-init             ="statements = [ 'sure you do.', 'omg', 'yep', 'whaaaaaaat.', 'yee, hah.', 'er, mah, ger.' ]"
            alert-this-and-that ="statement.toUpperCase() and statement.toLowerCase() for statement in statements"
        &gt;
            I do what I WANT... {{ statement }}
        &lt;/div&gt;
    &lt;/body&gt;

&lt;/html&gt;
</code></pre></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="the-regular-expressions">The Regular Expressions</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Our expression will be of the form <code>_alert_this_ and _alert_that for _ng_repeat_expression_</code>. So,
we just want a simple regular expression that matches groups for those three parts like so:</p></div></div><div class="code"><div class="wrapper"><span class="nv">alertThisAndThatRegex = </span><span class="sr">/^\s*([\s\S]+?)\s+and\s+([\s\S]+?)\s+for\s+([\s\S]+?)\s*$/</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="demystifying-ngrepeat">Demystifying ngRepeat</h4>

<p><em>FYI</em> The processing of ngRepeat's expression is just applying several regular expressions in phases.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For instance, this is the regex for splitting the ngRepeat expression into its left and right sides. I.e. <code>ng-
repeat="_left_side in _right_side_"</code></p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>ngRepeatRegex = /^\s*([\s\S]+?)\s+in\s+([\s\S]+?)\s*$/
</code></pre></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the regex for extracting the various value pieces from the ngRepeat's left side. I.e.
<code>_left_side</code> is <code>_value_|(_key_, _value_)</code></p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>ngRepeatLhsRegex = /^(?:([\$\w]+)|\(([\$\w]+)\s*,\s*([\$\w]+)\))$/
</code></pre></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We need $compile to build our ngRepeat template with the ngRepeat expression extracted from the directive attribute. (We also get $log to log errors appropriately.)</p></div></div><div class="code"><div class="wrapper"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span> <span class="s">&#39;aModule&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;ng&#39;</span> <span class="p">]</span> <span class="p">).</span><span class="nx">directive</span><span class="p">(</span> <span class="s">&#39;alertThisAndThat&#39;</span><span class="p">,</span> <span class="nf">( $compile, $log )-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>To prove we're not cheating, an isolate scope.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scope: </span><span class="p">{}</span>

  <span class="nv">transclude: </span><span class="kc">yes</span>

  <span class="nv">link: </span><span class="nf">( $scope, $element, $attrs ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We need $attrs to process our expression, and we need $transclude to pass to the child directive that's going to use it from within its ngRepeat.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">controller: </span><span class="nf">( $scope, $attrs, $transclude ) -&gt;</span>
    <span class="nv">expression = </span><span class="nx">$attrs</span><span class="p">.</span><span class="nx">alertThisAndThat</span>
    <span class="k">return</span> <span class="nx">$log</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;No expression for alertThisAndThat&quot;</span> <span class="k">unless</span> <span class="nx">expression</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Parse the overall expression:</p></div></div><div class="code"><div class="wrapper">    <span class="nv">matches = </span><span class="nx">expression</span><span class="p">.</span><span class="nx">match</span> <span class="nx">alertThisAndThatRegex</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And blow up if it didn't match:</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">$log</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;alertThisAndThat expression was malformed: </span><span class="si">#{</span> <span class="nx">expression</span> <span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">matches</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extract each sub-expression of it:</p></div></div><div class="code"><div class="wrapper">    <span class="nv">thisExpression     = </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span>
    <span class="nv">thatExpression     = </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
    <span class="nv">ngRepeatExpression = </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And blow up if any of them weren't there:</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">$log</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;alertThisAndThat expression missing the this expression: </span><span class="si">#{</span>     <span class="nx">expression</span> <span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">thisExpression</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="nx">$log</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;alertThisAndThat expression missing the that expression: </span><span class="si">#{</span>     <span class="nx">expression</span> <span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">thatExpression</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="nx">$log</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;alertThisAndThat expression missing the ngRepeat expression: </span><span class="si">#{</span> <span class="nx">expression</span> <span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">ngRepeatExpression</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then build the controller object and return it:</p></div></div><div class="code"><div class="wrapper">    <span class="nv">controller =</span>
      <span class="nv">$scope            : </span><span class="nx">$scope</span>
      <span class="nv">$transclude       : </span><span class="nx">$transclude</span>
      <span class="nv">thisExpression    : </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span>
      <span class="nv">thatExpression    : </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
      <span class="nv">ngRepeatExpression: </span><span class="nx">matches</span><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span>

  <span class="nv">template: </span><span class="s">&#39;&#39;&#39;</span>
<span class="s">    &lt;div class=&quot;no-wrap&quot;&gt;</span>

<span class="s">      &lt;div class=&quot;inline-block wrap more r-padded&quot;&gt;</span>
<span class="s">        &lt;div this-alerts&gt;&lt;/div&gt;</span>
<span class="s">      &lt;/div&gt;</span>

<span class="s">      &lt;div class=&quot;inline-block wrap&quot;&gt;</span>
<span class="s">        &lt;div that-alerts&gt;&lt;/div&gt;</span>
<span class="s">      &lt;/div&gt;</span>

<span class="s">    &lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>
<span class="p">).</span><span class="nx">directive</span><span class="p">(</span> <span class="s">&#39;thisAlerts&#39;</span><span class="p">,</span> <span class="nf">( $compile ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>So, we require alertThisAndThat from an ancestor element.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">require: </span><span class="s">&#39;^alertThisAndThat&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An isolate scope to ensure transclusion's $scope will be unpolluted.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scope: </span><span class="p">{}</span>

  <span class="nv">link: </span><span class="nf">( $scope, $element, $attrs, alertThisAndThatController ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now we build ngRepeat template and compile it.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The key here is to make this template absolutely as simple as possible.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><em>Future Note</em>: There's a very good reason for separating the alert-this from the
ngRepeat...to ensure we can get a clean/isolated scope for the transclusion that only has
what the ngRepeat puts on it for the transcluded template.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">compiledNgRepeat = </span><span class="nx">$compile</span> <span class="s">&quot;</span>
<span class="s">    &lt;div ng-repeat=&#39;</span><span class="si">#{</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">ngRepeatExpression</span> <span class="si">}</span><span class="s">&#39;&gt;</span>
<span class="s">      &lt;div alert-this&gt;&lt;/div&gt;</span>
<span class="s">    &lt;/div&gt;</span>
<span class="s">    &quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>Magic Alert!¡</strong> Then we link it to <em>the parent scope of the alertThisAndThat directive</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">compiledNgRepeat</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$parent</span><span class="p">,</span> <span class="nf">( $linkedNgRepeatElement ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And append it.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">$element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$linkedNgRepeatElement</span>

<span class="p">).</span><span class="nx">directive</span><span class="p">(</span> <span class="s">&#39;thatAlerts&#39;</span><span class="p">,</span> <span class="nf">( $compile ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>So, we require alertThisAndThat from an ancestor element.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">require: </span><span class="s">&#39;^alertThisAndThat&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An isolate scope to ensure transclusion's $scope will be unpolluted.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scope: </span><span class="p">{}</span>

  <span class="nv">link: </span><span class="nf">( $scope, $element, $attrs, alertThisAndThatController ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now we build ngRepeat template and compile it.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The key here is to make this template absolutely as simple as possible.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><em>Future Note</em>: There's a very good reason for separating the alert-that from the
ngRepeat...to ensure we can get a clean/isolated scope for the transclusion that only has
what the ngRepeat puts on it for the transcluded template.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">compiledNgRepeat = </span><span class="nx">$compile</span> <span class="s">&quot;</span>
<span class="s">    &lt;div ng-repeat=&#39;</span><span class="si">#{</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">ngRepeatExpression</span> <span class="si">}</span><span class="s">&#39;&gt;</span>
<span class="s">      &lt;div alert-that&gt;&lt;/div&gt;</span>
<span class="s">    &lt;/div&gt;</span>
<span class="s">    &quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>Magic Alert!¡</strong> Then we link it to <em>the parent scope of the alertThisAndThat directive</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">compiledNgRepeat</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$parent</span><span class="p">,</span> <span class="nf">( $linkedNgRepeatElement ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And append it.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">$element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$linkedNgRepeatElement</span>

<span class="p">).</span><span class="nx">directive</span><span class="p">(</span> <span class="s">&#39;alertThis&#39;</span><span class="p">,</span> <span class="nf">( $compile ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>So, we require alertThisAndThat from an ancestor element.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">require: </span><span class="s">&#39;^alertThisAndThat&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just to absolutely ensure we don't accidentally clobber anything in the ng-repeat's scope
(which we want to preserve, totally unpolluted for the transclusion of the alertThisAndThat
directive), we give this an isolate scope.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scope: </span><span class="p">{}</span>

  <span class="nv">link: </span><span class="nf">( $scope, $element, $attrs, alertThisAndThatController ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We declare the value that will be alerted when the button is clicked.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">thisValue = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And we watch the <em>this</em>expression_ extracted and saved on the require'd alertThisAndThat's
controller to update what we'll alert whenever it changes.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">thisExpression</span><span class="p">,</span> <span class="nf">( value ) -&gt;</span>
      <span class="nv">thisValue = </span><span class="nx">value</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Almost done, we define the alert function. And note that because this directive is
declared on/under an ngRepeat, all its scopes are "siblings" or in other words don't
clobber one another.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$scope.alert = </span><span class="nf">-&gt;</span> <span class="nx">alert</span> <span class="nx">thisValue</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally, we transclude the alertThisAndThat directive's contents <em>using this scope's
parent scope</em>, just to prove we can, and can do so with a completely unpolluted
transcluded scope that still has access to all the wonderful stuff ngRepeat puts on there:</p></div></div><div class="code"><div class="wrapper">    <span class="nx">debugger</span>
    <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">$transclude</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">$parent</span><span class="p">,</span> <span class="nf">( $transcludedAlertThis ) -&gt;</span>
      <span class="nx">$element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$transcludedAlertThis</span>

  <span class="nv">template: </span><span class="s">&#39;&#39;&#39;</span>
<span class="s">  &lt;div&gt;</span>
<span class="s">    &lt;button</span>
<span class="s">      class    =&quot;link appearance-none not-bordered rounded blue coloring red-flat-button&quot;</span>
<span class="s">      ng-click =&quot;alert()&quot;</span>
<span class="s">    &gt;</span>
<span class="s">      Alert This</span>
<span class="s">    &lt;/button&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>
<span class="p">).</span><span class="nx">directive</span><span class="p">(</span> <span class="s">&#39;alertThat&#39;</span><span class="p">,</span> <span class="nf">( $compile ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>So, we require alertThisAndThat from an ancestor element.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">require: </span><span class="s">&#39;^alertThisAndThat&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just to absolutely ensure we don't accidentally clobber anything in the ng-repeat's scope
 (which we want to preserve, totally unpolluted for the transclusion of the alertThisAndThat
 directive), we give this an isolate scope.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scope: </span><span class="p">{}</span>

  <span class="nv">link: </span><span class="nf">( $scope, $element, $attrs, alertThisAndThatController ) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We declare the value that will be alerted when the button is clicked.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">thatValue = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And we watch the <em>that</em>expression_ extracted and saved on the require'd alertThisAndThat's
controller to update what we'll alert whenever it changes.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span> <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">thatExpression</span><span class="p">,</span> <span class="nf">( value ) -&gt;</span>
      <span class="nv">thatValue = </span><span class="nx">value</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Almost done, we define the alert function. And note that because this directive is
declared on/under an ngRepeat, all its scopes are "siblings" or in other words don't
clobber one another.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$scope.alert = </span><span class="nf">-&gt;</span> <span class="nx">alert</span> <span class="nx">thatValue</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally, we transclude the alertThisAndThat directive's contents <em>using this scope's
parent scope</em>, just to prove we can, and can do so with a completely unpolluted
transcluded scope that still has access to all the wonderful stuff ngRepeat puts on there:</p></div></div><div class="code"><div class="wrapper">    <span class="nx">debugger</span>
    <span class="nx">alertThisAndThatController</span><span class="p">.</span><span class="nx">$transclude</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">$parent</span><span class="p">,</span> <span class="nf">( $transcludedAlertThat ) -&gt;</span>
      <span class="nx">$element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$transcludedAlertThat</span>

  <span class="nv">template: </span><span class="s">&#39;&#39;&#39;</span>
<span class="s">  &lt;div&gt;</span>
<span class="s">    &lt;button</span>
<span class="s">      class    =&quot;link appearance-none not-bordered rounded blue coloring red-flat-button&quot;</span>
<span class="s">      ng-click =&quot;alert()&quot;</span>
<span class="s">    &gt;</span>
<span class="s">      Alert That</span>
<span class="s">    &lt;/button&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>
<span class="p">)</span></div></div></div></div></body></html>